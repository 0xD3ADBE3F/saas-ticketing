// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// MULTI-TENANT CORE
// =============================================================================

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  email     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Contact person (for Mollie onboarding)
  firstName  String?           // Primary contact first name
  lastName   String?           // Primary contact last name

  // Mollie Connect
  mollieOrganizationId   String?   @unique
  mollieAccessToken      String?   // Encrypted
  mollieRefreshToken     String?   // Encrypted
  mollieTokenExpiresAt   DateTime?
  mollieOnboardingStatus MollieOnboardingStatus?
  mollieProfileId        String?
  mollieClientLinkUrl    String?

  // Mollie Onboarding Required Fields
  streetAndNumber   String?           // Street name and number (required for Mollie)
  postalCode        String?           // Postal/ZIP code (required for Mollie)
  city              String?           // City name (required for Mollie)
  country           String?  @default("NL") // ISO 3166-1 alpha-2 country code (required for Mollie)
  registrationNumber String?          // KVK number (optional)
  vatNumber         String?           // VAT/BTW number (optional)

  // Billing (for invoicing)
  billingEmail      String?           // Email for invoices

  // Onboarding tracking
  firstLoginCompleted Boolean @default(false) // Has user completed welcome screen

  // Relations
  memberships      Membership[]
  events           Event[]
  orders           Order[]
  payouts          Payout[]
  idempotencyKeys  IdempotencyKey[]
  scannerTerminals ScannerTerminal[]
  invoices         Invoice[]

  @@index([mollieOrganizationId])
  @@index([firstLoginCompleted])
  @@map("organizations")
}

enum MollieOnboardingStatus {
  PENDING
  NEEDS_DATA
  IN_REVIEW
  COMPLETED
}

model Membership {
  id             String   @id @default(uuid())
  organizationId String
  userId         String   // Supabase auth.users.id
  role           Role     @default(MEMBER)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
  @@map("memberships")
}

enum Role {
  ADMIN
  FINANCE
  SCANNER
  MEMBER
}

// =============================================================================
// EVENTS & TICKETS
// =============================================================================

model Event {
  id             String      @id @default(uuid())
  organizationId String
  title          String
  slug           String
  description    String?
  location       String?
  startsAt       DateTime
  endsAt         DateTime
  status         EventStatus @default(DRAFT)
  isPaid         Boolean     @default(true) // Does event have paid tickets (requires Mollie)?
  vatRate        VatRate     @default(STANDARD_21) // VAT rate for tickets

  // Service fee configuration (NULL = use platform defaults)
  // Platform admin can override these per event
  serviceFeeFixed      Int?    // Fixed fee in cents (e.g., 50 = â‚¬0.50)
  serviceFeePercentage Float?  // Percentage as decimal (e.g., 0.02 = 2%)
  serviceFeeMinimum    Int?    // Minimum fee in cents
  serviceFeeMaximum    Int?    // Maximum fee in cents

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ticketTypes      TicketType[]
  tickets          Ticket[]
  orders           Order[]
  scannerTerminals ScannerTerminal[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([status])
  @@index([isPaid])
  @@map("events")
}

enum EventStatus {
  DRAFT
  LIVE
  ENDED
  CANCELLED
}

enum VatRate {
  STANDARD_21
  REDUCED_9
  EXEMPT
}

model TicketType {
  id           String    @id @default(uuid())
  eventId      String
  name         String
  description  String?
  price        Int       // Price in cents (VAT-inclusive, shown to buyer)
  priceExclVat Int?      // Price excluding VAT (for organizer reporting)
  vatAmount    Int?      // VAT amount in cents (for organizer reporting)
  capacity     Int
  soldCount    Int       @default(0)
  saleStart    DateTime?
  saleEnd      DateTime?
  sortOrder    Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  event      Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tickets    Ticket[]
  orderItems OrderItem[]

  @@index([eventId])
  @@map("ticket_types")
}

model Ticket {
  id             String       @id @default(uuid())
  ticketTypeId   String
  eventId        String
  orderId        String
  code           String       @unique // Short human-readable code
  secretToken    String       @unique // For QR validation
  status         TicketStatus @default(VALID)
  usedAt         DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  ticketType TicketType @relation(fields: [ticketTypeId], references: [id])
  event      Event      @relation(fields: [eventId], references: [id])
  order      Order      @relation(fields: [orderId], references: [id])
  scanLogs   ScanLog[]

  @@index([eventId])
  @@index([orderId])
  @@index([status])
  @@map("tickets")
}

enum TicketStatus {
  VALID
  USED
  REFUNDED
}

// =============================================================================
// ORDERS & PAYMENTS
// =============================================================================

model Order {
  id              String      @id @default(uuid())
  organizationId  String
  eventId         String
  orderNumber     String      @unique
  buyerEmail      String
  buyerName       String?
  ticketTotal     Int         // Total ticket price in cents (VAT-inclusive)
  serviceFee      Int         // Service fee in cents (VAT-inclusive)
  serviceFeeExclVat Int?      // Service fee excluding VAT (for reporting)
  serviceFeeVat   Int?        // Service fee VAT amount (for reporting)
  totalAmount     Int         // Grand total in cents (VAT-inclusive)
  status          OrderStatus @default(PENDING)
  paymentId       String?     @unique // Mollie payment ID
  paymentMethod   String?
  paidAt          DateTime?
  refundedAt      DateTime?
  expiresAt       DateTime?   // When pending order expires
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id])
  event        Event        @relation(fields: [eventId], references: [id])
  tickets      Ticket[]
  orderItems   OrderItem[]

  @@index([organizationId])
  @@index([eventId])
  @@index([buyerEmail])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id           String @id @default(uuid())
  orderId      String
  ticketTypeId String
  quantity     Int
  unitPrice    Int    // Price per ticket in cents (snapshot)
  totalPrice   Int    // quantity * unitPrice in cents

  // Relations
  order      Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  ticketType TicketType @relation(fields: [ticketTypeId], references: [id])

  @@unique([orderId, ticketTypeId])
  @@index([orderId])
  @@map("order_items")
}

enum OrderStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
  REFUNDED
}

// =============================================================================
// SCANNING & AUDIT
// =============================================================================

model ScanLog {
  id             String     @id @default(uuid())
  ticketId       String
  scannedBy      String     // User ID who scanned
  deviceId       String?    // Device identifier
  result         ScanResult
  scannedAt      DateTime   // When the scan occurred (may be offline)
  syncedAt       DateTime?  // When synced to server (null if online)
  offlineSync    Boolean    @default(false)
  createdAt      DateTime   @default(now())

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id])

  @@index([ticketId])
  @@index([scannedAt])
  @@map("scan_logs")
}

enum ScanResult {
  VALID
  ALREADY_USED
  INVALID
  REFUNDED
}

model ScannerDevice {
  id             String    @id @default(uuid())
  organizationId String
  deviceId       String    // Unique device identifier (client-generated)
  name           String?   // Optional friendly name
  lastSyncAt     DateTime? // Last successful sync timestamp
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([organizationId, deviceId])
  @@index([organizationId])
  @@index([deviceId])
  @@map("scanner_devices")
}

// Scanner terminal codes for standalone mobile scanner authentication
model ScannerTerminal {
  id             String    @id @default(uuid())
  organizationId String
  eventId        String?   // Optional: restrict terminal to specific event
  code           String    @unique // 6-character uppercase code (e.g., "ABC123")
  name           String    // Display name (e.g., "Entrance 1", "VIP Gate")
  isActive       Boolean   @default(true)
  expiresAt      DateTime? // Optional expiration
  lastUsedAt     DateTime?
  createdBy      String    // User ID who created this terminal
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  event        Event?       @relation(fields: [eventId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([eventId])
  @@index([code])
  @@index([isActive])
  @@map("scanner_terminals")
}

model AuditLog {
  id             String   @id @default(uuid())
  organizationId String
  userId         String   // User who performed the action
  action         String   // e.g., "order.refund", "ticket.override", "ticket.resend"
  entityType     String   // e.g., "order", "ticket", "event"
  entityId       String   // ID of affected entity
  metadata       Json?    // Additional context (reason, old/new values, etc.)
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// =============================================================================
// INVOICING
// =============================================================================

enum InvoiceType {
  PLATFORM_FEE  // Post-event platform fee invoice
}

enum InvoiceStatus {
  DRAFT
  SENT
  PENDING
  PAID
  OVERDUE
  CANCELLED
  FAILED
}

model Invoice {
  id              String        @id @default(uuid())
  organizationId  String
  eventId         String?       // Optional link to specific event
  type            InvoiceType   @default(PLATFORM_FEE)

  // Mollie Sales Invoice API fields
  mollieSalesInvoiceId String?   @unique  // inv_xxxx from Sales Invoice API
  invoiceNumber        String?   @unique  // e.g., "2024-001"
  invoiceDate          DateTime  @default(now())
  dueDate              DateTime?

  // Financial details
  amount          Int           // Total amount in cents
  vatAmount       Int           @default(0) // VAT amount in cents
  vatRate         Decimal       @default(21.00) @db.Decimal(5, 2)  // e.g., 21.00 for 21%
  currency        String        @default("EUR")

  // Payment tracking
  status          InvoiceStatus @default(PENDING)
  molliePaymentId String?       @unique
  paidAt          DateTime?

  // PDF & Links
  pdfUrl          String?       // Mollie-hosted PDF URL

  // Metadata
  description     String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([eventId])
  @@index([status])
  @@index([molliePaymentId])
  @@index([invoiceDate])
  @@map("invoices")
}

// =============================================================================
// PAYOUTS
// =============================================================================

model Payout {
  id               String       @id @default(uuid())
  organizationId   String
  periodStart      DateTime
  periodEnd        DateTime
  grossRevenue     Int          // Total from used tickets in cents
  platformFee      Int          // Platform fee in cents
  netPayout        Int          // Amount to pay out in cents
  usedTicketCount  Int
  status           PayoutStatus @default(CALCULATED)
  approvedAt       DateTime?
  paidAt           DateTime?
  transferId       String?      // Mollie transfer ID
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@map("payouts")
}

enum PayoutStatus {
  CALCULATED
  APPROVED
  PAID
}

// =============================================================================
// IDEMPOTENCY
// =============================================================================

model IdempotencyKey {
  id             String   @id @default(uuid())
  key            String   // Idempotency key from client
  organizationId String
  endpoint       String   // API endpoint path
  statusCode     Int
  response       Json     // Cached response body
  expiresAt      DateTime // 24h TTL
  createdAt      DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([key, organizationId])
  @@index([organizationId])
  @@index([expiresAt])
  @@map("idempotency_keys")
}

// =============================================================================
// PLATFORM ADMIN
// =============================================================================

model SuperAdmin {
  id        String   @id @default(uuid())
  userId    String   @unique // Supabase auth.users.id
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  auditLogs AdminAuditLog[]

  @@index([userId])
  @@index([email])
  @@map("super_admins")
}

model AdminAuditLog {
  id          String   @id @default(uuid())
  adminId     String   // SuperAdmin.id
  action      String   // e.g., "organization.suspend", "user.impersonate", "plan.change"
  entityType  String?  // e.g., "organization", "user", "payment"
  entityId    String?  // ID of affected entity
  metadata    Json?    // Additional context (old values, reason, etc.)
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  // Relations
  admin SuperAdmin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("admin_audit_logs")
}
